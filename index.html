<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Oru Village â€“ Oru Market</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
header{background:#15803d;color:#fff;padding:16px;text-align:center;font-size:20px}
.container{max-width:1100px;margin:auto;padding:15px}
.card{background:#fff;padding:16px;border-radius:10px;margin-bottom:15px;box-shadow:0 5px 20px rgba(0,0,0,.08)}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ddd}
button{cursor:pointer}
.green{background:#16a34a;color:#fff;border:none}
.outline{background:#fff;color:#16a34a;border:1px solid #16a34a}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px}
img{width:100%;height:150px;object-fit:cover;border-radius:6px;margin-top:6px}
.hidden{display:none}
.price{color:#15803d;font-weight:bold}
.badge{background:#e7f7ec;color:#15803d;padding:4px 8px;border-radius:20px;font-size:12px}
.actions{display:flex;gap:8px;margin-top:10px}
@media(max-width:600px){ header{font-size:18px} }
</style>
</head>

<body>
<header>ğŸŒ¾ Oru Village â€“ Oru Market</header>

<div class="container">

<!-- ROLE -->
<div id="role" class="card">
  <button class="green" onclick="adminLogin()">ğŸ›¡ï¸ Admin</button>
  <button class="green" onclick="showTech()">ğŸ‘¨â€ğŸ’» Tech Person</button>
  <button class="outline" onclick="showBuyer()">ğŸ›’ Buyer</button>
</div>

<!-- ADMIN -->
<div id="admin" class="card hidden">
  <h3>ğŸ›¡ï¸ Admin Panel</h3>
  <input id="adminCrop" placeholder="Crop name">
  <input id="adminPrice" placeholder="Market price">
  <button class="green" onclick="updatePrice()">Update Market Price</button>
  <button class="outline" onclick="back()">Back</button>
</div>

<!-- TECH -->
<div id="tech" class="card hidden">
  <h3>ğŸ‘¨â€ğŸ’» Tech Person</h3>
  <input id="techPhone" placeholder="Tech Phone">
  <input id="farmer" placeholder="Farmer Name">
  <input id="village" placeholder="Village">
  <select id="crop" onchange="loadMarketPrice()">
    <option>Rice</option>
    <option>Karumbu</option>
    <option>Maize</option>
    <option>Vegetables</option>
  </select>
  <input id="price" placeholder="Price (auto from market)">
  <input id="qty" placeholder="Quantity">
  <input type="file" id="images" multiple>
  <button class="green" onclick="saveCrop()">Save Crop</button>
  <button class="outline" onclick="back()">Back</button>
</div>

<!-- BUYER -->
<div id="buyer" class="hidden">
  <h3>ğŸ›’ Available Crops</h3>
  <div id="cropList" class="grid"></div>
  <button class="outline" onclick="back()">Back</button>
</div>

</div>

<script>
const API_URL = "https://farmer-service-9e5o.onrender.com";
const ADMIN_PIN = "8610694904";

/* NAV */
function showTech(){ hideAll(); tech.classList.remove("hidden"); }
function showBuyer(){ hideAll(); buyer.classList.remove("hidden"); loadCrops(); }
function back(){ hideAll(); role.classList.remove("hidden"); }
function hideAll(){ role.classList.add("hidden"); admin.classList.add("hidden"); tech.classList.add("hidden"); buyer.classList.add("hidden"); }

/* ADMIN */
function adminLogin(){
  const pin = prompt("Enter Admin PIN");
  if(pin===ADMIN_PIN){
    hideAll(); admin.classList.remove("hidden");
  } else alert("Wrong PIN");
}

function updatePrice(){
  fetch(API_URL+"/admin/price",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      crop:adminCrop.value,
      price:adminPrice.value,
      adminPin:ADMIN_PIN
    })
  }).then(()=>alert("Market price updated"));
}

/* TECH */
function loadMarketPrice(){
  fetch(API_URL+"/price/"+crop.value)
    .then(r=>r.json())
    .then(d=>price.value=d.price);
}

async function saveCrop(){
  let imgs=[];
  for(let f of images.files) imgs.push(await toBase64(f));
  fetch(API_URL+"/crop",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      techPhone:techPhone.value,
      farmer:farmer.value,
      village:village.value,
      crop:crop.value,
      price:price.value,
      qty:qty.value,
      images:imgs
    })
  }).then(()=>alert("Crop saved"));
}

function toBase64(f){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.readAsDataURL(f);
  });
}

/* BUYER */
function loadCrops(){
  fetch(API_URL+"/crops")
    .then(r=>r.json())
    .then(data=>{
      cropList.innerHTML="";
      data.forEach((c,i)=>{
        const msg = encodeURIComponent(
`Hello ${c.farmer} ğŸ‘‹,

I want to order the following crop:

ğŸŒ¾ Crop : ${c.crop}
ğŸ“¦ Quantity : ${c.qty}
ğŸ’° Price : â‚¹${c.price}
ğŸ“ Village : ${c.village}

Thank you ğŸ™`
        );
        cropList.innerHTML+=`
        <div class="card">
          <b>${c.farmer}</b> <span class="badge">${c.village}</span><br>
          ğŸŒ¾ ${c.crop}<br>
          <span class="price">â‚¹${c.price}</span><br>
          Qty: ${c.qty}
          ${c.images.map(im=>`<img src="${im}">`).join("")}
          <div class="actions">
            <a href="tel:${c.techPhone}"><button class="green">ğŸ“ Call</button></a>
            <a href="https://wa.me/91${c.techPhone}?text=${msg}" target="_blank">
              <button class="outline">ğŸ’¬ WhatsApp</button>
            </a>
          </div>
          <button onclick="deleteCrop(${i})">âŒ Delete</button>
        </div>`;
      });
    });
}

function deleteCrop(id){
  const phone = prompt("Enter your tech phone");
  fetch(API_URL+"/crop/"+id,{
    method:"DELETE",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ techPhone:phone })
  }).then(r=>{
    if(r.status===403) alert("Not allowed");
    else loadCrops();
  });
}
</script>
</body>
</html>
