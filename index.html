<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Market-App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;font-family:Arial}
body{margin:0;background:#f3f4f6}
header{background:#15803d;color:#fff;padding:15px;text-align:center;font-size:20px}
.container{max-width:1000px;margin:auto;padding:20px}
.card{background:#fff;padding:15px;border-radius:8px;margin-bottom:15px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
button{padding:10px;width:100%;border:none;border-radius:5px;margin:5px 0;cursor:pointer}
.green{background:#16a34a;color:#fff}
.outline{border:1px solid #16a34a;background:#fff;color:#16a34a}
input,select{padding:8px;width:100%;margin:5px 0}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:10px}
.hidden{display:none}
.price{color:#15803d;font-weight:bold}
img{width:100%;max-height:150px;object-fit:cover;border-radius:6px;margin-top:5px}
</style>
</head>

<body>

<header>ğŸŒ¾ Oru Village â€“ Oru Market</header>

<div class="container">

<!-- ROLE -->
<div id="role" class="card">
  <button id="adminBtn" class="green hidden" onclick="showAdmin()">ğŸ›¡ï¸ Admin</button>
  <button class="green" onclick="showTech()">ğŸ‘¨â€ğŸ’» Tech Person</button>
  <button class="outline" onclick="showBuyer()">ğŸ›’ Buyer</button>
</div>

<!-- ADMIN -->
<div id="admin" class="card hidden">
  <h3>ğŸ›¡ï¸ Admin Panel</h3>
  <input id="adminCrop" placeholder="Crop name (e.g. Rice)">
  <input id="adminPrice" placeholder="Market price">
  <button class="green" onclick="updatePrice()">Update Price</button>
  <button class="outline" onclick="back()">Back</button>
</div>

<!-- TECH PERSON -->
<div id="tech" class="card hidden">
  <h3>ğŸ‘¨â€ğŸ’» Tech Person</h3>
  <input id="techPhone" placeholder="Tech Person Phone">
  <input id="farmer" placeholder="Farmer Name">
  <input id="village" placeholder="Village">
  <select id="crop">
    <option>Rice</option>
    <option>Karumbu</option>
    <option>Maize</option>
    <option>Vegetables</option>
  </select>
  <input id="price" placeholder="Price">
  <input id="qty" placeholder="Quantity">
  <input type="file" id="images" multiple accept="image/*">
  <button class="green" onclick="saveCrop()">Save Crop</button>
  <button class="outline" onclick="back()">Back</button>
</div>

<!-- BUYER -->
<div id="buyer" class="hidden">
  <h3>ğŸ›’ Available Crops</h3>
  <div id="cropList" class="grid"></div>
  <button class="outline" onclick="back()">Back</button>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://farmer-service-9e5o.onrender.com"; // your Render URL
const ADMIN_PIN = "1234"; // CHANGE THIS PIN (admin laptop only)

/* ================= ADMIN DEVICE LOCK ================= */
window.onload = () => {
  if (localStorage.getItem("isAdmin") === "true") {
    document.getElementById("adminBtn").classList.remove("hidden");
  } else {
    const pin = prompt("Enter Admin PIN (Admin laptop only)");
    if (pin === ADMIN_PIN) {
      localStorage.setItem("isAdmin","true");
      document.getElementById("adminBtn").classList.remove("hidden");
      alert("Admin enabled on this device");
    }
  }
};

/* ================= NAV ================= */
function showAdmin(){ role.classList.add("hidden"); admin.classList.remove("hidden"); }
function showTech(){ role.classList.add("hidden"); tech.classList.remove("hidden"); }
function showBuyer(){ role.classList.add("hidden"); buyer.classList.remove("hidden"); loadCrops(); }
function back(){
  admin.classList.add("hidden");
  tech.classList.add("hidden");
  buyer.classList.add("hidden");
  role.classList.remove("hidden");
}

/* ================= ADMIN ================= */
function updatePrice(){
  fetch(API_URL+"/admin/price",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ crop:adminCrop.value, price:adminPrice.value })
  }).then(()=>alert("Market price updated"));
}

/* ================= TECH PERSON ================= */
async function saveCrop(){
  const files = images.files;
  let imgs = [];
  for (let f of files) imgs.push(await toBase64(f));

  const data = {
    techPhone:techPhone.value,
    farmer:farmer.value,
    village:village.value,
    crop:crop.value,
    price:price.value,
    qty:qty.value,
    images:imgs
  };

  fetch(API_URL+"/crop",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  }).then(()=>alert("Crop saved"));
}

function toBase64(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });
}

/* ================= BUYER ================= */
function loadCrops(){
  fetch(API_URL+"/crops")
    .then(r=>r.json())
    .then(data=>{
      cropList.innerHTML="";
      data.forEach((c,i)=>{
        let imgs="";
        if(c.images) c.images.forEach(im=> imgs+=`<img src="${im}">`);

        const msg = encodeURIComponent(
          `Hello ${c.farmer},\nI want ${c.crop}\nQty: ${c.qty}\nPrice: â‚¹${c.price}\nVillage: ${c.village}`
        );

        cropList.innerHTML+=`
        <div class="card">
          <b>${c.farmer}</b> (${c.village})<br>
          ğŸŒ¾ ${c.crop}<br>
          <span class="price">â‚¹${c.price}</span><br>
          Qty: ${c.qty}<br><br>
          ${imgs}
          <p>ğŸ“ ${c.techPhone}</p>
          <a href="tel:${c.techPhone}"><button class="green">ğŸ“ Call</button></a>
          <a href="https://wa.me/91${c.techPhone}?text=${msg}" target="_blank">
            <button class="outline">ğŸ’¬ WhatsApp</button>
          </a>
          <button onclick="deleteCrop(${i})">âŒ Delete</button>
        </div>`;
      });
    });
}

function deleteCrop(id){
  const phone = prompt("Enter Tech Phone");
  fetch(API_URL+"/crop/"+id,{
    method:"DELETE",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ techPhone:phone })
  }).then(r=>{
    if(r.status==403) alert("Not allowed");
    else loadCrops();
  });
}
</script>

</body>
</html>
