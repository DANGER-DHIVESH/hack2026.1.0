<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Oru Village â€“ Oru Market</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;font-family:system-ui,Arial}
body{margin:0;background:#f3f4f6}
header{background:#15803d;color:#fff;padding:14px;text-align:center;font-size:18px}
.container{max-width:1100px;margin:auto;padding:14px}
.card{background:#fff;padding:14px;border-radius:12px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
h3{margin:6px 0 10px}
button{padding:12px;width:100%;border:none;border-radius:10px;margin:6px 0;cursor:pointer;font-size:15px}
.green{background:#16a34a;color:#fff}
.outline{border:1px solid #16a34a;background:#fff;color:#16a34a}
input,select{padding:10px;width:100%;margin:6px 0;border-radius:10px;border:1px solid #ddd}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.hidden{display:none}
.price{color:#15803d;font-weight:700}
.badge{background:#dcfce7;color:#166534;padding:4px 8px;border-radius:999px;font-size:12px;margin-left:6px}
.actions{display:flex;gap:8px}
.actions a{flex:1}
img{width:100%;max-height:140px;object-fit:cover;border-radius:8px;margin-top:6px}
@media (max-width:600px){
  header{font-size:16px}
  button{font-size:16px}
}
</style>
</head>

<body>

<header>ğŸŒ¾ Oru Village â€“ Oru Market</header>

<div class="container">

<!-- ROLE -->
<div id="role" class="card">
  <button id="adminBtn" class="green hidden" onclick="showAdmin()">ğŸ›¡ï¸ Admin</button>
  <button class="green" onclick="showTech()">ğŸ‘¨â€ğŸ’» Tech Person</button>
  <button class="outline" onclick="showBuyer()">ğŸ›’ Buyer</button>
</div>

<!-- ADMIN -->
<div id="admin" class="card hidden">
  <h3>ğŸ›¡ï¸ Admin Panel</h3>
  <input id="adminCrop" placeholder="Crop name (e.g. Rice)">
  <input id="adminPrice" placeholder="Market price">
  <button class="green" onclick="updatePrice()">Update Market Price</button>
  <button class="outline" onclick="back()">Back</button>
</div>

<!-- TECH -->
<div id="tech" class="card hidden">
  <h3>ğŸ‘¨â€ğŸ’» Tech Person</h3>
  <input id="techPhone" placeholder="Tech Phone">
  <input id="farmer" placeholder="Farmer Name">
  <input id="village" placeholder="Village">
  <select id="crop">
    <option>Rice</option>
    <option>Karumbu</option>
    <option>Maize</option>
    <option>Vegetables</option>
  </select>
  <input id="price" placeholder="Price (auto from market)">
  <input id="qty" placeholder="Quantity">
  <input type="file" id="images" multiple accept="image/*">
  <button class="green" onclick="saveCrop()">Save Crop</button>
  <button class="outline" onclick="back()">Back</button>
</div>

<!-- BUYER -->
<div id="buyer" class="hidden">
  <h3>ğŸ›’ Available Crops</h3>
  <div id="cropList" class="grid"></div>
  <button class="outline" onclick="back()">Back</button>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://farmer-service-9e5o.onrender.com"; // CHANGE if needed
const ADMIN_PIN = "8610694904"; // admin laptop only

/* ================= ADMIN LOCK ================= */
window.onload = () => {
  if (localStorage.getItem("isAdmin")==="true") {
    adminBtn.classList.remove("hidden");
  } else {
    const pin = prompt("Enter Admin PIN (Admin laptop only)");
    if (pin === ADMIN_PIN) {
      localStorage.setItem("isAdmin","true");
      adminBtn.classList.remove("hidden");
      alert("Admin enabled on this device");
    }
  }
};

/* ================= NAV ================= */
function showAdmin(){ role.classList.add("hidden"); admin.classList.remove("hidden"); }
function showTech(){ role.classList.add("hidden"); tech.classList.remove("hidden"); }
function showBuyer(){ role.classList.add("hidden"); buyer.classList.remove("hidden"); loadCrops(); }
function back(){
  admin.classList.add("hidden");
  tech.classList.add("hidden");
  buyer.classList.add("hidden");
  role.classList.remove("hidden");
}

/* ================= ADMIN ================= */
function updatePrice(){
  fetch(API_URL+"/admin/price",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ crop:adminCrop.value, price:adminPrice.value })
  }).then(()=>alert("Market price updated"));
}

/* ================= TECH ================= */
crop.addEventListener("change", async ()=>{
  const r = await fetch(API_URL+"/price/"+crop.value);
  const d = await r.json();
  if (d.price !== "Not updated") price.value = d.price;
});

async function saveCrop(){
  localStorage.setItem("myTechPhone", techPhone.value);

  let imgs=[];
  for(let f of images.files){
    imgs.push(await toBase64(f));
  }

  fetch(API_URL+"/crop",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      techPhone:techPhone.value,
      farmer:farmer.value,
      village:village.value,
      crop:crop.value,
      price:price.value,
      qty:qty.value,
      images:imgs
    })
  }).then(()=>alert("Crop saved"));
}

function toBase64(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}

/* ================= BUYER ================= */
async function loadCrops(){
  const myPhone = localStorage.getItem("myTechPhone");
  const data = await fetch(API_URL+"/crops").then(r=>r.json());
  cropList.innerHTML="";

  for(let i=0;i<data.length;i++){
    const c=data[i];
    const mp=await fetch(API_URL+"/price/"+c.crop).then(r=>r.json());
    let imgs="";
    if(c.images) c.images.forEach(im=> imgs+=`<img src="${im}">`);

    const msg = encodeURIComponent(
      `Hello ${c.farmer},\nInterested in ${c.crop}\nQty: ${c.qty}\nPrice: â‚¹${c.price}\nVillage: ${c.village}`
    );

    const canDelete = myPhone && myPhone===c.techPhone;

    cropList.innerHTML+=`
      <div class="card">
        <b>${c.farmer}</b> (${c.village})<br>
        ğŸŒ¾ ${c.crop}<br>
        <span class="price">â‚¹${c.price}</span>
        <span class="badge">Market: â‚¹${mp.price}</span><br>
        Qty: ${c.qty}<br>
        ${imgs}
        <div class="actions">
          <a href="tel:${c.techPhone}">
            <button class="green">ğŸ“ Call</button>
          </a>
          <a href="https://wa.me/91${c.techPhone}?text=${msg}" target="_blank">
            <button class="outline">ğŸ’¬ WhatsApp</button>
          </a>
        </div>
        ${canDelete ? `<button onclick="deleteCrop(${i})">âŒ Delete</button>` : ``}
      </div>`;
  }
}

function deleteCrop(id){
  fetch(API_URL+"/crop/"+id,{
    method:"DELETE",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ techPhone: localStorage.getItem("myTechPhone") })
  }).then(()=>loadCrops());
}
</script>

</body>
</html>
