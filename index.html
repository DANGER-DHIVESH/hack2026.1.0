<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Oru Village â€“ Oru Market</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{--g:#15803d}
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:#f4f6f8}
header{background:var(--g);color:#fff;padding:16px;text-align:center;font-size:22px}
.container{max-width:1100px;margin:auto;padding:20px}
.card{background:#fff;padding:16px;border-radius:12px;margin-bottom:16px;
box-shadow:0 10px 25px rgba(0,0,0,.08)}
input,select,button{width:100%;padding:10px;margin:6px 0;border-radius:8px}
button{border:none;cursor:pointer}
.green{background:#16a34a;color:#fff}
.outline{border:1px solid var(--g);background:#fff;color:var(--g)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
img{width:100%;height:160px;object-fit:cover;border-radius:8px}
.hidden{display:none}
.price{font-weight:700;color:var(--g)}
.actions{display:flex;gap:8px}
@media(max-width:600px){header{font-size:18px}}
</style>
</head>

<body>
<header>ğŸŒ¾ Oru Village â€“ Oru Market</header>

<div class="container">

<div class="card">
  <button onclick="adminLogin()">ğŸ›¡ï¸ Admin</button>
  <button onclick="showTech()">ğŸ‘¨â€ğŸ’» Tech Person</button>
  <button onclick="showBuyer()">ğŸ›’ Buyer</button>
</div>

<!-- ADMIN -->
<div id="admin" class="card hidden">
  <h3>Admin Panel</h3>
  <input id="apass" placeholder="Admin password">
  <input id="acrop" placeholder="Crop">
  <input id="aprice" placeholder="Market price">
  <button class="green" onclick="updatePrice()">Update</button>
</div>

<!-- TECH -->
<div id="tech" class="card hidden">
  <h3>Tech Person</h3>
  <input id="tphone" placeholder="Tech phone">
  <input id="farmer" placeholder="Farmer name">
  <input id="village" placeholder="Village">
  <select id="crop" onchange="loadMarket()">
    <option>Rice</option><option>Karumbu</option><option>Maize</option>
  </select>
  <input id="price" placeholder="Price (auto from market)">
  <input id="qty" placeholder="Quantity">
  <input type="file" id="imgs" multiple>
  <button class="green" onclick="saveCrop()">Save Crop</button>
</div>

<!-- BUYER -->
<div id="buyer" class="hidden">
  <h3>Available Crops</h3>
  <div id="list" class="grid"></div>
</div>

</div>

<script>
const API="https://farmer-service-9e5o.onrender.com";

// ---------- NAV ----------
function hideAll(){admin.classList.add("hidden");tech.classList.add("hidden");buyer.classList.add("hidden")}
function showTech(){hideAll();tech.classList.remove("hidden")}
function showBuyer(){hideAll();buyer.classList.remove("hidden");loadCrops()}

// ---------- ADMIN ----------
function adminLogin(){
  const p=prompt("admin password");
  fetch(API+"/admin/login",{method:"POST",headers:{'Content-Type':'application/json'},
  body:JSON.stringify({pass:p})})
  .then(r=>r.ok?admin.classList.remove("hidden"):alert("Wrong password"))
}
function updatePrice(){
  fetch(API+"/admin/price",{method:"POST",headers:{'Content-Type':'application/json'},
  body:JSON.stringify({crop:acrop.value,price:aprice.value})})
  .then(()=>alert("Price updated"))
}

// ---------- TECH ----------
function loadMarket(){
  fetch(API+"/price/"+crop.value)
  .then(r=>r.json()).then(d=>price.value=d.price)
}
async function saveCrop(){
  let images=[]
  for(let f of imgs.files) images.push(await to64(f))
  fetch(API+"/crop",{method:"POST",headers:{'Content-Type':'application/json'},
  body:JSON.stringify({
    techPhone:tphone.value,farmer:farmer.value,village:village.value,
    crop:crop.value,price:price.value,qty:qty.value,images
  })}).then(()=>alert("Saved"))
}
function to64(f){return new Promise(r=>{let fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(f)})}

// ---------- BUYER ----------
function loadCrops(){
  fetch(API+"/crops").then(r=>r.json()).then(data=>{
    list.innerHTML=""
    data.forEach((c,i)=>{
      let imgs=c.images?.map(im=>`<img src="${im}">`).join("")||""
      let msg=encodeURIComponent(`Need ${c.crop} Qty:${c.qty}`)
      list.innerHTML+=`
      <div class="card">
        <b>${c.farmer}</b> â€“ ${c.village}<br>
        ğŸŒ¾ ${c.crop}<br>
        <span class="price">â‚¹${c.price}</span><br>
        Qty: ${c.qty}
        ${imgs}
        <div class="actions">
          <a href="tel:${c.techPhone}"><button class="green">Call</button></a>
          <a href="https://wa.me/91${c.techPhone}?text=${msg}" target="_blank">
            <button class="outline">WhatsApp</button></a>
        </div>
      </div>`
    })
  })
}
</script>
</body>
</html>
